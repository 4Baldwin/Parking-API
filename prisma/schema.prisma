generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// (Enums: SpaceStatus, TicketStatus ...)
enum SpaceStatus {
  AVAILABLE
  RESERVED
  OCCUPIED
  PENDING_VACATE
}
enum TicketStatus {
  RESERVED
  PARKED
  COMPLETED
  NO_SHOW
  PENDING_PAYMENT
  PAID
  OVERSTAYING
}

// (Models: User, PasswordResetToken, ParkingLot, Zone, Space ...)
model User {
  id                  String               @id @default(cuid())
email               String               @unique
  password            String
  name                String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  tickets             Ticket[]
  passwordResetTokens PasswordResetToken[]
}
model PasswordResetToken {
  id        String   @id @default(cuid())
token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  @@index([userId])
}
model ParkingLot {
  id    String @id @default(cuid())
  name  String
  zones Zone[]
}
model Zone {
  id     String     @id @default(cuid())
  name   String
  lotId  String
  lot    ParkingLot @relation(fields: [lotId], references: [id])
  spaces Space[]
}
model Space {
  id              String      @id @default(cuid())
  code            String
  zoneId          String
  zone            Zone        @relation(fields: [zoneId], references: [id])
  status          SpaceStatus @default(AVAILABLE)
  currentTicketId String?
  tickets         Ticket[]
  @@unique([zoneId, code])
}

// --- (*** แก้ไข Model Ticket ***) ---
model Ticket {
  id           String     @id @default(cuid())
  spaceId      String
  space        Space      @relation(fields: [spaceId], references: [id])
vehiclePlate String
  status       TicketStatus

  // --- (START) ส่วนที่แก้ไข/เพิ่ม ---
  
  // (เพิ่ม) เก็บว่าผู้ใช้เลือกจอง 30 หรือ 60 นาที
  // (เพิ่ม @default(30) เพื่อแก้ปัญหา Migrate)
  prePaidDurationMinutes Int      @default(30)
  
// (เหมือนเดิม) ตั้งค่าหลังจ่าย 15/30 บาท
  reservationStartTime DateTime?
  
  // (เปลี่ยนชื่อจาก pricePaidOnReservation) เก็บ "ยอดสะสม" ที่จ่ายแล้วทั้งหมด
  cumulativePaid Decimal @default(0) @db.Decimal(10, 2)
  
  // --- (END) ส่วนที่แก้ไข ---

checkinAt            DateTime?
checkoutAt           DateTime?
totalParkingFee      Decimal?   @db.Decimal(10, 2)
amountDue            Decimal?   @db.Decimal(10, 2)
cancellationReason   String?
gracePeriodStartedAt DateTime?
  createdAt            DateTime   @default(now())
userId               String?
user                 User?      @relation(fields: [userId], references: [id])
}
// --- (สิ้นสุด Model Ticket) ---